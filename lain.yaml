appname: streamrouter

build:
  base: laincloud/centos-lain:20170405
  prepare:
    version: "2"
    script:
      - yum install -y supervisor
      - yum clean all
      - ./haproxy_install.sh

  script:
    - mkdir -p $GOPATH/src/github.com/laincloud
    - ln -s /lain/app $GOPATH/src/github.com/laincloud/streamrouter
    - go build -o streamwatcher $GOPATH/src/github.com/laincloud/streamrouter/main.go
    - cp -f supervisord.conf /etc/supervisord.conf
    - mkdir -p /etc/haproxy/stream.d
    - cp -f haproxy.cfg /etc/haproxy/haproxy.cfg

test:
  script:
    - go test -v github.com/laincloud/streamrouter/backend

worker:
  cmd: ./start.sh
  num_instances: 2
  env:
    - LAINLET_PORT=9001
    - GRAPHITE_PORT=2003
    - HAPROXY_PID_FILE=/var/run/haproxy.pid
  memory: 256m

notify:
  slack: "#lain"